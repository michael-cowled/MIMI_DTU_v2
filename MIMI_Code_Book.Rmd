---
title: "MIMI: Microbial Interaction Metabolite Integrator"
author: "Michael Cowled"
date: "10/12/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Packages required to be loaded in:

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(readxl)
```

## NovaC files

The raw data was extracted from Agilent Chemstation LCMS/HPLC using the NovaC.mac or NovaH.mac macro which generates and Excel file with the following name: "002-D1F-D7-_F7vF2.D_NovaH", as an example.

File names were tidied up to remove unnecessary prefixes or suffixes: "F7vF2".

This name tidying and the creation of the Interaction_Matrix below, are the only manual steps performed.

## The Interaction Matrix

A table in excel format with the heading names as follows is required to be loaded in by the user.
The matrix should contain all interactions to be investigated.

```{r}
Interaction_Matrix <- read_excel("Interaction_Matrix.xlsx")
head(Interaction_Matrix)
```

## The core function, MIMI

The following functions are to be pre-loaded prior to use of the main function, MIMI()

1. **Read_Excel:** Reads in the NovaC files corresponding to a particular row number in the Interaction_Matrix.
2. **UVcheck1:** Compares the top 5 UV maxima of a matched peak in CON1 and the coculture.
3. **UVcheck2:** Compares the top 5 UV maxima of a matched peak in CON2 and the coculture.
4. **Read_UV:** Reads in the UV spectral data (abs vs. wavelength) for the corresponding 3 samples being compared.
5. **UVSubtract1:** Subtracts the UV spectrum of CON1 from the coculture, and takes the mean(Abs).
6. **UVSubtract2:** Subtracts the UV spectrum of CON2 from the coculture, and takes the mean(Abs)
7. **PeakMatcher1:** Matches and verifies peaks from CON1 to peaks in the coculture, utilising a combination of retention time, number of matching UV maxima (UVcheck1) and the means of the subtracted UV spectra (UVsubtract1).
8. **PeakMatcher2:** Matches and verifies peaks from CON2 to peaks in the coculture, utilising a combination of retention time, number of matching UV maxima (UVcheck2) and the means of the subtracted UV spectra (UVsubtract2).
9. **CON_Consolidator:** Consolidates the outcome table to match peaks from coculture to a single peak in a control. Compares subtracted UV spectra to make decisions based on double matching.
10. **Effect_Categoriser:** Characterises the Peak Area ratio as an effect to the metabolite in the coculture (induction, suppression, etc.).
11.**Simple_Effect_Characteriser:** Uses the principles of the Effect_Categoriser function to categorise based on a single PeakRatio input.
11. **NON_UV_Peak_Matcher:** Tentatively assigns matched peaks as non UVs (or as distorted UVs) if matching the conditions.
11. **Double_Peak_Remover:** Checks for a peak in the control being assigned to more than one peak in the coculture. Uses the number of matching UV maxima and/or the subtracted UV spectra to make decisions as to which peak is a better match.
12. **Missing_Control_Peaks:** Adds in unassigned peaks from the controls to provide a single, unified table.

Please see the full script to load in the whole suite of functions and review annotations for extra details.
The final main function, **MIMI**, combines the use of all 12 functions in providing the final tidied output files.

## The output file

An example output file is as follows:

```{r, echo = FALSE}
head(read.csv("Testing Broad-Scale Interactions/OutputFiles/F1vF2.csv"))
```

The resulting output file contains the following columns containing:

1. **Sample_Ref:** The reference sample - the default is the coculture, unless the peak from a control is not present.
2. **PeakNo_CC:** The peak number as present in the coculture sample.
3. **RetTime_CC:** The retention time (in min) for the peak in the coculture sample.
4. **PeakArea_CC:** The peak area for the peak in the coculture sample.
5. **Matched_CON:** The control sample with a matching peak to the sample reference.
6. **PeakNo_CON:** The peak number as present in the matched control or reference control sample.
7. **RetTime_CON:** The retention time (in min) for the peak in the control sample.
8. **PeakArea_CON:** The peak area for the peak in the control sample.
9. **UV_Count:** The number of UV maxima that match between the control and coculture peaks.
10. **Subtracted_UV_Mean:** The mean of the subtracted UV spectra (in Absorbance units) of the control from the coculture.
11. **PeakRatio:** The relative ratio (in %) of the reference sample compared to the control.
12. **Metabolite_Effect:** A categorised effect on the metabolite in the reference sample as determined by the PeakRatio.
These effects are:
*Complete Suppression:* Peak Area = -100%
| *Suppression:* -100% < Peak Area <= -20%
| *Little to No Change:* -20% < Peak Area < 20%
*Enhancement:* 20 <= Peak Area < 100%
| *Major enhancement:* Peak area >=100%
| *Induction:* NA (No peak area to compare to in CON)

*An extra note for analysis*: Tentative assignments of non-UVs/distorted-UVs can be determined by the following piece of code. It is worthwhile performing the analysis with and without these matches.

```{r}
#Let x <- Coculture_Name (of interest)
x <- "F15vF5"
df_Name <- read.csv(paste0("Testing Broad-Scale Interactions/OutputFiles/", x, ".csv"))
filter(df_Name, !is.na(Matched_CON) & is.na(Subtracted_UV_Mean))
```

Hence, there are 4 peaks identified as Non-UVs or distorted-UVs.

